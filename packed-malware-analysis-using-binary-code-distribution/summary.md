# パッキングされたマルウェアのバイナリコード解析
## 概要
パッキングされたマルウェアのコード断片の出現頻度やコードの類似性からパッキングされたマルウェアの種類やパッカーの種類の判別を目指す。

// マルウェアに対し圧縮を行い、圧縮効率の違いからマルウェアを分類する手法があるらしい。パッキングは元々プログラムの圧縮にも用いられていたこともあり、圧縮されているデータと似たような特性を示しそう。エントロピーとか情報量とかその辺りの話かな。

## 関連研究
N-gramを使ってバイナリコードの検出をする研究、圧縮による分類の研究。

// パッカーによって圧縮効率が違うから分類できる？

### N-gramによるコード解析
// N-gram = バイト列を長さNで切り出して取り出し、1バイトずらすを繰り返して作るワードリスト?検索の手法、簡単にできる。

Abou-Assalehによって提案された[1]。
N-gramの例: N = 2, "test" => "Te" "es" "st"

分割して作成したワードリストを検索することで、検索したいバイト列を発見する。
この手法ではマルウェアからN-gramを用いてコードを抜き出し、コードの出現頻度のプロファイルを作成して分類する。
プロファイルからマルウェア同士の距離を定義し、k-近傍法を適用して分類する。

### 圧縮手法を用いたマルウェア分別
Tao Gongらによって提案された[2]。
コードパターンによって圧縮率が異なることに着目し分類する。
機能の類似したオペコードを同一の表現になるよう中間コードへと変換している。
命令だけに着目し、オペランドは排除している。
PPM圧縮モデルにて作成、複数のモデルを適用し最も高い圧縮率だったものに分類する。
パッキングされていないマルウェアにしか使えない。

// どちらかというとコードの情報量というより命令列の情報量といった感じ?

## 目的
パッキングされたマルウェアをアンパックせずにマルウェアの分類やパッカーの特定をしたい。

N-gramを用いて頻度を抽出し分類する。
パッキングされたあとのバイトコードでも出現頻度は変わらないと仮定を立てて、推測可能ではないかとしている。
パッカー特有のバイト列を発見したり、パッキング手法に由来する特徴がバイト列に表れると推測されている。

// バイトコードの出現頻度が変わらないのは単一換字式っぽいからか周期があるか？

検証対象をx86に限定している。

バイナリコードの出現頻度による分類と、バイナリコードをベクトル化して分類する手法の2つを提案する。

## コードの出現頻度による手法
同じバイナリコードの総和から、同じバイナリコードで同じ出現数となるもののの割合を使う？

### 実験
実験対象のマルウェアは以下の方法で収集した。
+ 不審なURLのリストが掲載されているサイト[2]からファイルをダウンロード
+ マルウェアのサンプルを配布するサイト[4]
ウェブサイト[3]を利用して入手したファイルがマルウェアかどうかの判定にVirusTotalを使用。
adware, backdoor, wormの3種類をマルウェアを収集した。
検体8、パッカー3で、それぞれの組み合わせに対して判定を行った。

パッカーは以下の3つ
+ Yoda's Protecter 1.03.3
+ Telock 0.98
+ Upack 0.399

検体のうちひとつにtelockが適用できなかったため、ひとつ少ない31種類の検体を解析した。

解析は、2バイトずつずらして32バイト長読み込み、そのバイト列を比較するバイナリコードとしている。
読み込んだ値と出現数を記録しておく。
他のマルウェアで同じ読み込み値と出現数が含まれているかどうかを調べる。
総出現数と出現数が同じ値の総出現数を求める? 

// 誤植？最初の総出現数がどの出現数か分からない。2つのマルウェアのワードリストと出現数を記録する。同じワードで出現数が一致するものの総和が総出現数?

### 結果
異なるパッカーでも同じマルウェアであれば類似性が見られる。
パッカーが同じだと類似性が見られる。

同じマルウェアであっても類似しているとは限らないことが判明した。
同じバイナリコードが少なすぎると類似度が高くなってしまう。

## コードベクトルによる手法
ビットが一致している数をバイナリコードのビット長で割って類似度とする。

### 実験
N-gramでバイナリコードを抽出し、類似度を評価した。
マルウェアA,Bの類似度の計算方法は以下。

1. まずマルウェアAのあるバイナリコードとマルウェアBの全バイナリコードの類似度を計算し、最大値を収集する。
2. 次に収集した最大値の平均と分散を計算した。

N-gramは16Byte抜き出しで4Byte単位でずらす。

同一のマルウェアで平均が低くなった。
平均はパッカーではなくマルウェア依存ではないかと判断されている。
同種のパッカーを使うと分散が大きくなっている。

### 考察
実験に用いた検体が小さいため、平均が小さくなったのではないかと推測されている。
マルウェアの特定は難しいのではないかと考察している。

// サイズが小さいのが原因なら、大きいマルウェアではどうなる?

同じパッカーで分散が大きいのは類似度1のコードがあったのが理由である。

// パッカーによる解凍コードなどが同一で、それが検出された

パッカー固有の同一のバイナリコードが確認されているため、シグネチャベースの検出が提案されている。

## 参考文献
[1] Tony Abou-Assaleh, Nick Cercone, Vlado Keˇselj, Ray Sweidan "N-gram-based Detection of New Malicious Code" Computer Software and Applications Conference, 2004. COMPSAC 2004. Proceedings of the 28th Annual Interna-tional
[2] Tao Gong, Xiaobin Tan, Ming Zhu, "Malware Detection via Classifying With Compression" Information Science and Engineering (ICISE), 2009 1st International Conference o
[3] 「The VirusWatch Archives」http://lists.clean-mx.com/ pipermail/viruswatch/ (参照 2016-2-1) 
[4]「Open Malware」http://www.offensivecomputing.net/ (参照 2016-2-1) 
[5]「virustotal」https://www.virustotal.com/ja/(参照 2016-2-1) 
[6]「X86 Opcode and Instruction Reference」http://ref.x86asm.net (参照 2016-2-1)

