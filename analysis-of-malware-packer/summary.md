JAISTの課題研究報告書
[https://dspace.jaist.ac.jp/dspace/bitstream/10119/14807/5/paper.pdf]
[https://dspace.jaist.ac.jp/dspace/handle/10119/14807]

# マルウェアによるパッカー利用の解析
## 背景
これまでのパッカー研究
+ パッカー自体の特性や同定手法に関する研究
+ パッキングされたマルウェアのアンパックに関する研究

どちらの場合でも主要なテーマは圧縮ロジックの解析とOEPの同定である
=> 圧縮ロジックじゃなくて解凍ロジックじゃないのか?

パッカーの同定ではバイナリパターンの解析が一般的[3,4,5]
CFF Explorer
あまり有効な手段がない

小川研究室のプログラムの制御フローグラフを生成するBE-PUM(Binary Emulator for Pushdown Model generation)を使って、逆アセンブル(?)によるパッカーの同定の研究をしている[6,7]
bepum.jaist.ac.jp

パッカーが用いるRE妨害のための隠蔽手法にはパッカー毎に利用傾向があることが既存研究から明らかになっている
=> 参考文献がなかった、探す
隠蔽化テクニックにより実行されるCPU命令に規則性があると仮定して、逆アセンブルした結果の命令パターンからパッカーによる解凍コードとマルウェアの命令の分離をした。

サンプルはVXHeavenから
[http://vxheaven.org]

## 関連研究
パッカーで行われる典型的な隠蔽化テクニックの既存のサーベイ結果[8]
BE-PUMを使ったパッカーの隠蔽化テクニック同定研究[7]

[7]では、[8]をもとに分類、観察し検出方法を提案している
この分類に沿った隠蔽化テクニックの出現頻度をサンプルから計測して、その結果を利用してパッカーの同定をしている。同定には[9]を参考にカイ2乗検定を使っている

OEPの検出も可能になると書いているが、付近の文章の意味が読解できない。

1サンプルを除いてサンプルのものは全て同定できた

## マルウェアの典型的手法とパッカーの隠蔽化テクニック
既存研究から6グループに隠蔽化テクニックを分類している

### 1.Entry/code placing obfuscation: Code layout
x86系のアーキテクチャの命令が可変長であるという特徴を利用して、ひとつの命令列を複数のブロックで保持して実行時に結合する。
=> 分割して結合するということだろうか？

### 2.Self-modification code (Dynamic code: overwritin and packing/unpacking)
コードの一部または全部の上書き、暗号化、復号化を行うもの

### 3.Instruction obfuscation: Indirect jump
call, jump, returnで利用するオペランドを書き換えて実行後にジャンプする先を変更する

### 4.Anti-tracing: SEH, 2API(LoadLibrary, GetProcAddress)
=> トレーシングの妨害か?解説がない

### 5.Arithmetic operation: Obfuscatied constants, check summing
オペコードに演算をかけて直接値を保持しない
デバッグによるint 3の置き換えを検知するためチェックサムを使う
=> 細かく演算して値を分かりにくくするのか?

### 6.Anti-tampering: Timing check, anti-debuging, anti-rewriting, hardware breakpoints
一般的なデバッガ検知
ブレークポイント設置の確認やブレークポイント迂回のためのstolen bytes

## BE-PUMの概要とパッカー同定
x86に対応している
プログラムのフローグラフ生成をする
コンコリック(concolic = concrete + symbolic)テストを活用している
SATソルバーを利用して実行時に値が満たすべき条件を算出して、実行パスを網羅している。

既存研究から分かったパックされたマルウェアの特徴
+ 解凍用コードによる元のファイルの解凍
  - VirtualAllocによる領域の確保やIATの復元、GetProcAddressとLoadLibraryによるライブラリ関数の動的ロード
+ 完全性チェック対応
  - RDTSC命令で実行時間の計測など。=> 完全性か?
+ デバッグモード検出
  - エミュレータやデバッガを検知する
  
これらの特徴を踏まえて、BE-PUMではパッカー同定のためによく使われる200のx86命令と140のWinAPIの追加サポート、バイナリエミュレーション実行時の実メモリシミュレーション、ツラップフラグとデバッグレジスターの追加などの機能拡張がされている。

## パッカーおよびOEP同定のアプローチ
