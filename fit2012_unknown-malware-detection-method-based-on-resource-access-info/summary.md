# リソースアクセス情報に基づく未知のマルウェア検知手法
## 1 概要
パターンマッッチングでは未知のマルウェアや変種[1]に対応できない、一方ヒューリスティック方式[2][3]では誤検知率が高くなりがちで、検知率を上げるのが難しい。
ヒューリスティック方式ではマルウェアの挙動から判定する。
この研究では、リソースアクセス情報を利用した検知手法を提案し、ヒューリスティック方式に組み込む価値があるかを確認する。

## 2 検知手法
### 2.1 パターンマッチング方式
### 2.2 ヒューリスティック方式
プログラム構造、動作、その他の属性からマルウェアかどうかを判定する。
静的解析
パッカー、アンチデバッグの構造

動的解析
サンドボックス実行

## 3. 提案手法
プログラムのリソースへのアクセスに関する情報を利用してマルウェアの検知をする手法を提案する。
リソースアクセスはプログラムが実行したファイルとレジストリに対する書き込み、読み込み、削除のことである。

### 3.1 概要
検知の概要は以下のようになる。
1. 仮想マシン上で実行し、正常なプログラムとマルウェアのリソースアクセス情報を収集する
2. 収集したリソースアクセス情報から特徴を抽出する
3. 抽出した特徴から検知する

### 3.2 リソースアクセス情報収集
ファイルとレジスタに対する書き込み、読み込み、削除の6種類の情報を収集した。
マルウェアの全検体の中でどれだけの割合がリソースアクセスしたか、割合を求める。
正常プログラムも同様

### 3.3 リソースリスト
どれだけのリソースアクセスがあったか、ファイルやレジストリごとに集計している。
どれだけアクセスがあったかをポイントにする。割合から閾値を決めてポイントへと変換する。詳しくは5に。
正の値はマルウェアがアクセスしていることを示し、負の値は正常プログラムがアクセスしていることを示す。

### 3.4 マルウェア検知
検体プログラムのリソースアクセスと事前に作成したリソースリストを照らし合わせ、ポイントを合算する。
閾値を設定し、越えたらマルウェアであると判定する。
終了まで越えなければ正常と判断する。

### 3.5 提案手法の目標
検知エンジンへの組み込みの基準となる、検知率30%以上あるいは従来とは異なる手法で一定の検知率、誤検知率0.001%以下の2つを満すことを目標とするらしい[4]。

## 4 評価方法
### 4.1 システム構成
VMware上でリソースアクセス情報を収集し、仮想マシン上で検知実験をする。
Process Monitorで収集

### 4.2 リソースアクセス情報収集
983329体のマルウェア検体と111311体の正常プログラムからそれぞれ1万体をランダムに選択してリソースリスト生成に使う。
収集環境はXP。

### 4.3 マルウェア検知
983329体のマルウェアと111311体の正常プログラムからそれぞれ1万体選んで検知する。
リソースアクセス情報収集に使用したのとは別のプログラムにする。

検知環境も収集環境と同じ。

## 5 リソースリスト作成と評価
### 5.1 特徴抽出方法
#### 5.1.1 マルウェアの特徴
マルウェアポイント加算の条件は以下
+ マルウェア利用率 >= 40% & 正常系利用率 < 15%
+ マルウェア利用率 >= 30% & 正常系利用率 < 10%
+ マルウェア利用率 >= 20% & 正常系利用率 < 8%
+ マルウェア利用率 >= 10% & 正常系利用率 < 4%
+ マルウェア利用率 >= 5% & 正常系利用率 < 1.6%
ポイントは以下のように計算される。
マルウェアポイント = (マルウェア利用率 - 正常系利用率) * 5

#### 5.1.1 正常系プログラムの特徴
+ 正常系利用率 >= 40% & マルウェア利用率 < 20%
+ 正常系利用率 >= 30% & マルウェア利用率 < 15%
+ 正常系利用率 >= 20% & マルウェア利用率 < 11%
+ 正常系利用率 >= 10% & マルウェア利用率 < 5%
+ 正常系利用率 >= 5% & マルウェア利用率 < 1.6%
マルウェアポイント = (正常系利用率 - マルウェア利用率) * -5

### 5.2 検知能力評価
検知率 34.95%
誤検知率 4.00%

誤検知率が高過ぎる。

## 6 誤検知防止手法と評価
誤検知が多いので減らす。

### 6.1 誤検知防止手法
#### 6.1.1 類似リソース圧縮
似たようなパスでファイル名だけ違うリソースにアクセスするような場合があったり、マルウェアポイントの高いリソースにアクセスするとポイントの合計が高くなりすぎて誤検知したりすることが判明した。
類似しているリソースをひとつにまとめることで誤検知を防ぐ。
+ パス名が部分一致、名前が一致
  - 共通部分でまとめ、異なる部分をワイルドカードにする
+ パスが一致
  - これも名前をワイルドカードにする

#### 6.1.2 類似リソース圧縮の対象
リソースの圧縮をすることで似たリソースに複数回アクセスするマルウェアのポイントが低くなるので、検知率が下がる恐れがある。
このため、リソース圧縮をする対象を選択している。

正常プログラムの検知能力評価をして、誤検知の原因となったリソースを対象にする。
この原因とは正のポイントが与えられた、アクセスされたリソースである。

### 6.2 検知能力評価
検知率 10%
誤検知率 0.03%

まだ誤検知率が高い上に、検知率が下がってしまった。

## 7 静的解析情報利用
既存の静的解析エンジンを利用して、さらにフィルタリングした。
その結果、検知率9.05%、誤検知率0%になった。

## 参考文献 
[1]  McAfee 脅威レポート:2010 年第三四半期 http://www.mcafee.com/japan/media/mcafeeb2b/international/japan/pdf/threatreport/threatreport10q3.pdf 
[2] 神薗 雅紀，白石 善明，森井 昌克，“仮想ネットワー クを使った未知ウィルス検知システム，”情報処理学会研究報告 コンピュータセキュリティ，Vol.16，No.22，pp. 113-120（2003） 
[3]  岩本 一樹，和崎 克己，“コンピュータウイルスのコ ード静的解析による特徴抽出と分類について，” 電子情報通信学会技術研究報告，Vol.107，No.397，pp.107-113（2007） 
[4]  株式会社フォティーンフォティ技術研究所 http://www.fourteenforty.jp/ [5]  VMware. Inc. http://www.vmware.com/ 
[6]  Windows Sysinternals TechCenter http://technet.microsoft.com/ja-jp/sysinternals/bb896645.a 

# memo
なぜ静的解析によるフィルタリングを最初の検知方法で試さなかったか？
検知率が高い方で試した方がいい気がする。

これより前にリソースアクセスによる解析手法はなかった？

ある動作をするプログラムが一律にアクセスするリソースを対象に含めると誤検知しやすいような気がする。
リソースアクセスの例でも圧倒的に読み込みが多く、おそらくは設定の読み込みなのでマルウェアかどうかの区別にはあまり向かないと思う。
リソースアクセスの組み合わせを特徴に組み込むか、読み込みは外して書き込みと削除に絞った方が検知率は上がる気がする。

TODO: この研究の手法から読み込みを外してるような後続の研究を探す
